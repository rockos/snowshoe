/* for screen */
var fs = require('fs');


/*
 * Mar-25-2012
 */
function showPart(req, res) {
    var sql2 ='select * from part';
    client.query(sql2, function(err, results, fields) {
	    if (err){
		console.log('err: ' + err);
	    }
	    var dsp = {'title':'入庫画面','scrhead':'MySQLを使った画面','comment':'JSON Data','tab':results};
	    /* for debug
	    console.log('results=> ',results);
	    console.log('results[0].pcode=> ',results[0].pcode);
	    console.log('dsp.dcrheade=> ',dsp.scrhead);
	    console.log('dsp.tab[0]=> ',dsp.tab[0]);
	    console.log('dsp.tab[0]=> ',dsp.tab[0].pcode);
	    */
	    res.render('scr/scr201', dsp);
	});
};
/*
 * Mar-28-2012
 */
function registPart(req, res, post) {
    /*    console.log(req.body);
    console.log(req.files);
    console.log('req,body: ', req.body);
    */

    /* insert SQL */
    var insSql ='insert into part (pcode,sqty,lotn,mem1,mem2,mem3,pnam) ';
	insSql += 'values (?,?,?,?,?,?,?)';
    var ary = [];
    ary = [req.body.pcode, req.body.sqty,req.body.lotn,req.body.mem1,req.body.mem2,req.body.mem3, req.body.pnam];
    client.query(insSql, ary,
		 function(err, results) {
		     if (err){
			 console.log('err: ' + err);
		     }
		     var dsp = {'title':'登録完了','scrhead':'HAHA','comment':'JSON','tab':results};
		     console.log('results: ', results);
		     /* return res.render('scr/scr201', post); */
		     showPart(req, res);
		 });
    
}

/*
 * main routine
 * date 22.mar.2012
 */
exports.main = function(req, res){
    var file = './controller/data/str.json';
    var deffile = './controller/data/def201.json';

    if (req.body['query1'] == 'Query') {
	showPart(req, res);
    } else if (req.body['regist1'] == 'Regist') {
	var posts = JSON.parse(require('fs').readFileSync(file));
	registPart(req, res, posts);
    } else if (req.body['update'] == 'UPDATE') {
	var posts = JSON.parse(require('fs').readFileSync(file));
	res.render('scr/scr201', posts);
    } else {
	var posts = JSON.parse(require('fs').readFileSync(deffile));
	/*	res.render('scr/scr201', posts); */
	showPart(req, res);
    }
};

/*
  showPart(req, req) {
  var sql2 = 'select ...';
  client.query(sql2, function(err, results, fields) {
  var sql3 = 'select ...'
  client.query(sql3, function(err, result, fields) {
  res.render('scr/scr201', posts);
  });
  });
  };

*/

/*
  fs.readFile('/data/iqy.json'', "utf-8", function (err, data) {
  time = 0;
  data = data.split('\n').forEach(function (val, i) {
  time += +val
    })
        r = parseInt((time/60))+'\n'+(time%60)

	    fs.writeFile(file, r);
    });
*/